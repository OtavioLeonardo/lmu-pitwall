<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PitWall AI Pro - Mobile Ready</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* ========================================= */
        /* === THEME VARIABLES === */
        /* ========================================= */
        :root {
            --bg-core: #050505;
            --bg-panel: #0f0f0f;
            --bg-card: #141414;
            --border-main: #333333;
            --border-light: #444444;
            --text-primary: #e5e5e5;
            --text-secondary: #a3a3a3;
            --text-muted: #666666;
            --accent-gold: #FFD700;
            --accent-cyan: #00BFFF;
            --accent-red: #FF4500;
            --accent-green: #2ecc71;
            --accent-orange: #e67e22;
        }

        /* ========================================= */
        /* === GLOBAL STYLES === */
        /* ========================================= */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            background-color: var(--bg-core);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            line-height: 1.5;
        }

        /* === Header === */
        header {
            background: linear-gradient(to bottom, var(--bg-card), var(--bg-panel));
            border-bottom: 1px solid var(--border-main);
            padding: 0 15px;
            height: 54px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        h1 {
            font-size: 16px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
            font-weight: 700;
        }

        h1 .brand {
            color: var(--accent-gold);
        }

        .badge {
            font-size: 10px;
            background: var(--accent-gold);
            color: #000;
            padding: 2px 6px;
            border-radius: 2px;
            font-weight: bold;
        }

        .toolbar {
            display: flex;
            gap: 8px;
        }

        .btn {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 2px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .btn:hover {
            background: var(--border-main);
            color: var(--text-primary);
            border-color: var(--text-secondary);
        }

        .btn-primary {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            color: #000;
            font-weight: bold;
        }

        .btn-outline {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* === Layout === */
        .layout {
            display: grid;
            grid-template-columns: 340px 1fr;
            grid-template-rows: 60% 40%;
            gap: 12px;
            padding: 12px;
            flex-grow: 1;
            overflow: hidden;
            position: relative;
        }

        /* === Cards === */
        .card {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-main);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .card-header {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border-main);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-gold);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
        }

        .card-body {
            flex-grow: 1;
            position: relative;
            min-height: 0;
        }

        /* Sidebar & Data Grid */
        .sidebar {
            grid-row: 1 / span 2;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            padding-right: 2px;
        }

        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .sidebar::-webkit-scrollbar {
            width: 4px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #333;
        }

        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: var(--border-main);
            border-bottom: 1px solid var(--border-main);
        }

        .data-cell {
            background: var(--bg-panel);
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .data-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .data-value {
            font-size: 15px;
            font-weight: bold;
            font-family: 'Consolas', monospace;
            color: var(--text-primary);
        }

        .data-target {
            font-size: 9px;
            margin-top: 4px;
            padding: 2px 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-muted);
        }

        /* Track Selector */
        .track-selector-container {
            padding: 10px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border-main);
        }

        select#track-selector {
            width: 100%;
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            padding: 8px;
            border-radius: 4px;
            font-size: 13px;
            outline: none;
        }

        /* Loading */
        #loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent-cyan), transparent);
            z-index: 2000;
            animation: loading 1s infinite;
        }

        @keyframes loading {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .help-tip {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-muted);
            pointer-events: none;
            font-size: 14px;
        }

        /* FAB Button */
        .fab-container {
            position: fixed;
            bottom: 25px;
            right: 25px;
            z-index: 999;
            display: flex;
            flex-direction: column-reverse;
            align-items: flex-end;
        }

        .fab-main {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent-gold);
            border: 2px solid #000;
            color: #000;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .ai-menu {
            margin-bottom: 15px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px);
            transition: 0.3s;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        .fab-container:hover .ai-menu {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .ai-btn {
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 13px;
            border: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        /* ç§»åŠ¨ç«¯æç¤ºæ¨ªå¹… */
        .mobile-banner {
            display: none;
            background: #2a2a2a;
            color: var(--accent-gold);
            font-size: 10px;
            text-align: center;
            padding: 4px;
            border-bottom: 1px solid var(--accent-gold);
        }

        /* ========================================= */
        /* === MOBILE RESPONSIVE LOGIC === */
        /* ========================================= */
        @media (max-width: 768px) {
            body {
                height: auto;
                overflow-y: auto;
                padding-bottom: 80px;
                /* Space for FAB */
            }

            .layout {
                display: block;
                /* è¦†ç›– grid */
                padding: 10px;
                height: auto;
                overflow: visible;
            }

            .sidebar {
                width: 100%;
                height: auto;
                overflow: visible;
                gap: 15px;
            }

            /* å¼ºåˆ¶éšè—å³ä¾§å›¾è¡¨åŒºåŸŸ (Visual Only) */
            /* æ³¨æ„ï¼šæˆ‘ä»¬ä½¿ç”¨ position absolute ç§»å‡ºå±å¹•è€Œä¸æ˜¯ display:none */
            /* è¿™æ · Canvas ä»ç„¶å­˜åœ¨ï¼ŒjsPDF æ‰èƒ½æˆªå›¾ç”ŸæˆæŠ¥å‘Š */
            .chart-section {
                position: absolute;
                left: -9999px;
                top: -9999px;
                width: 800px;
                /* ç»™ä¸€ä¸ªå›ºå®šå®½åº¦ä»¥ä¿è¯ç”Ÿæˆ PDF æ—¶æœ‰æ’ç‰ˆ */
                height: 400px;
                visibility: hidden;
            }

            header h1 {
                font-size: 14px;
            }

            .btn span {
                display: none;
                /* æ‰‹æœºä¸Šåªæ˜¾ç¤ºå›¾æ ‡æˆ–ç®€åŒ–æ–‡å­— */
            }

            /* æ˜¾ç¤ºç§»åŠ¨ç«¯æç¤º */
            .mobile-banner {
                display: block;
            }

            /* è°ƒæ•´å¡ç‰‡é«˜åº¦é€‚åº”æ‰‹æœº */
            .card {
                min-height: auto;
            }
        }
    </style>
</head>

<body>

    <div id="loader"></div>
    <input type="file" id="fileInput" accept=".csv" style="display:none">

    <header>
        <h1>ğŸ <span class="brand">PITWALL</span><span class="badge">V2.7</span></h1>
        <div class="toolbar">
            <button class="btn" onclick="resetZoom()" style="display: none;" id="btn-reset">ğŸ” é‡ç½®</button>
            <button class="btn btn-outline" onclick="generatePDF()">ğŸ“„ PDF <span
                    style="display:inline-block">ä¸‹è½½</span></button>
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">ğŸ“‚ å¯¼å…¥</button>
        </div>
    </header>

    <div class="mobile-banner">
        âš ï¸ ç§»åŠ¨ç«¯ç²¾ç®€æ¨¡å¼ï¼šè¯¦ç»†é¥æµ‹å›¾è¡¨å·²éšè—ï¼Œè¯·ä½¿ç”¨â€œPDF ä¸‹è½½â€æŸ¥çœ‹å®Œæ•´æ•°æ®ã€‚
    </div>

    <div class="layout" id="main-layout">
        <div class="sidebar">
            <div class="card" style="flex-shrink:0">
                <div class="card-header">
                    <span>èµ›é“è®¾å®š</span>
                    <span id="track-type-badge" class="badge" style="background:#444; color:#fff">Select</span>
                </div>
                <div class="track-selector-container">
                    <select id="track-selector">
                        <option value="" disabled selected>-- è¯·é€‰æ‹©èµ›é“ --</option>
                    </select>
                </div>
                <div
                    style="padding: 10px; font-size: 12px; color: var(--text-secondary); line-height: 1.4; border-top: 1px solid var(--border-main);">
                    <span id="track-desc">åŠ è½½æ•°æ®ä»¥å¼€å§‹åˆ†æ...</span>
                    <div style="margin-top:5px; color: var(--accent-gold); font-weight:bold" id="track-benchmark"></div>
                </div>
            </div>

            <div class="card" style="flex-shrink:0">
                <div class="card-header">é©¾é©¶è¡¨ç°åˆ†æ (Data)</div>
                <div class="data-grid">
                    <div class="data-cell"><span class="data-label">åœˆé€Ÿ (Time)</span><span class="data-value"
                            id="val-time">--</span></div>
                    <div class="data-cell"><span class="data-label">æé€Ÿ (Top)</span><span class="data-value"
                            id="val-top">--</span></div>
                    <div class="data-cell">
                        <span class="data-label">æ»‘è¡Œ (Coast)</span>
                        <span class="data-value" id="val-coast">--</span>
                        <span class="data-target" id="target-coast">Target: --</span>
                    </div>
                    <div class="data-cell">
                        <span class="data-label">å¾ªè¿¹ (Trail)</span>
                        <span class="data-value" id="val-trail">--</span>
                        <span class="data-target" id="target-trail">Target: --</span>
                    </div>
                    <div class="data-cell"><span class="data-label">æ²¹é—¨å¹³é¡º</span><span class="data-value"
                            id="val-smooth">--</span></div>
                    <div class="data-cell"><span class="data-label">åˆ¹è½¦å¹³é¡º</span><span class="data-value"
                            id="val-brake-smooth">--</span></div>
                </div>
            </div>

            <div class="card" style="min-height: 250px;">
                <div class="card-header">èµ›é“çƒ­åŠ›å›¾ (Map)</div>
                <div class="card-body"><canvas id="mapChart"></canvas></div>
            </div>

            <div class="card" style="height: 250px; flex-shrink:0">
                <div class="card-header">æ‘©æ“¦åœ† (G-Force)</div>
                <div class="card-body"><canvas id="ggChart"></canvas></div>
            </div>
        </div>

        <div class="card chart-section" style="grid-column: 2; grid-row: 1;">
            <div class="card-header">
                <span>é€Ÿåº¦ / è½¬é€Ÿ / æŒ¡ä½</span>
                <span
                    style="font-size:10px; opacity:0.7; color: var(--text-muted); font-weight: normal;">Alt+æ»šè½®ç¼©æ”¾</span>
            </div>
            <div class="card-body">
                <canvas id="mainChart"></canvas>
                <div id="tip-main" class="help-tip">è¯·å¯¼å…¥ CSV æ•°æ®</div>
            </div>
        </div>

        <div class="card chart-section" style="grid-column: 2; grid-row: 2;">
            <div class="card-header">è½¦æ‰‹è¾“å…¥ (Input Telemetry)</div>
            <div class="card-body">
                <canvas id="inputChart"></canvas>
            </div>
        </div>
    </div>

    <div class="fab-container">
        <button class="fab-main" title="AI åˆ†æ">ğŸ¤–</button>
        <div class="ai-menu">
            <div
                style="font-size: 11px; color: var(--text-muted); margin-bottom: 5px; background: rgba(0,0,0,0.8); padding: 4px 8px; border-radius: 4px;">
                å¤åˆ¶æŒ‡ä»¤å¹¶è·³è½¬ï¼š
            </div>
            <button class="ai-btn" onclick="askAI('deepseek')">DeepSeek</button>
            <button class="ai-btn" onclick="askAI('yuanbao')">è…¾è®¯å…ƒå®</button>
        </div>
    </div>

    <script>
        let rawData = [];
        let charts = {};
        let meta = { track: 'Unknown', car: 'Unknown' };
        let promptText = "";
        let maxDistance = 0;
        let mapRatio = 1;
        let currentStats = null;

        // æ ·å¼é…ç½®
        const style = getComputedStyle(document.body);
        const colors = {
            cyan: style.getPropertyValue('--accent-cyan').trim(),
            gold: style.getPropertyValue('--accent-gold').trim(),
            red: style.getPropertyValue('--accent-red').trim(),
            green: style.getPropertyValue('--accent-green').trim(),
            text: style.getPropertyValue('--text-secondary').trim(),
            grid: style.getPropertyValue('--border-main').trim(),
            warn: style.getPropertyValue('--accent-orange').trim()
        };

        // èµ›é“æ•°æ®åº“
        const TRACK_DB = {
            'bahrain': { label: 'Bahrain', type: 'Stop-Go', desc: 'é‡åˆ¹åŒºå¤šï¼Œç‰µå¼•åŠ›è‡³å…³é‡è¦ã€‚', trail: [10, 18], coast: [2, 8], bench: '1:58.7' },
            'imola': { label: 'Imola', type: 'Technical', desc: 'åˆ‡è·¯è‚©æå…¶å‡¶ç‹ ï¼Œæ€¥åœæ€¥èµ·ã€‚', trail: [10, 18], coast: [0, 6], bench: '1:41.9' },
            'monza': { label: 'Monza', type: 'Power', desc: 'é€Ÿåº¦æ®¿å ‚ï¼Œé‡åˆ¹æ•ˆç‡æ˜¯å…³é”®ã€‚', trail: [5, 12], coast: [0, 5], bench: '1:48.6' },
            'spa': { label: 'Spa', type: 'Fast/Flowing', desc: 'é«˜é€Ÿä¸èŠ‚å¥çš„å®Œç¾ç»“åˆã€‚', trail: [6, 14], coast: [2, 8], bench: '2:17.2' },
            'suzuka': { label: 'Suzuka', type: 'Technical', desc: 'è‘—åçš„8å­—å½¢èµ›é“ï¼ŒSå¼¯æè€ƒç ”èŠ‚å¥ã€‚', trail: [8, 16], coast: [2, 10], bench: '1:58.0' },
            'sebring': { label: 'Sebring', type: 'Bumpy', desc: 'æå…¶é¢ ç°¸ï¼Œéœ€Trail Brakingå‹è½¦å¤´ã€‚', trail: [12, 22], coast: [0, 6], bench: '2:00.1' },
            'le_mans': { label: 'Le Mans', type: 'High Speed', desc: 'æé€Ÿç›´é“ï¼Œå¼¯é“å°‘ä½†å…³é”®ã€‚', trail: [5, 12], coast: [0, 5], bench: '3:55.7' },
            'default': { label: 'Custom Track', type: 'Balanced', desc: 'ç»¼åˆå‹èµ›é“æ ‡å‡†ã€‚', trail: [5, 15], coast: [0, 12], bench: '--' }
        };

        function initTrackSelector() {
            const selector = document.getElementById('track-selector');
            Object.keys(TRACK_DB).forEach(key => {
                if (key === 'default') return;
                const opt = document.createElement('option');
                opt.value = key;
                opt.innerText = TRACK_DB[key].label;
                selector.appendChild(opt);
            });
            const defOpt = document.createElement('option');
            defOpt.value = 'default';
            defOpt.innerText = 'Other / Custom';
            selector.appendChild(defOpt);
            selector.addEventListener('change', (e) => updateTrackProfile(e.target.value));
        }

        function updateTrackProfile(trackKey) {
            const profile = TRACK_DB[trackKey] || TRACK_DB['default'];
            document.getElementById('track-type-badge').innerText = profile.type;
            document.getElementById('track-desc').innerText = profile.desc;
            document.getElementById('track-benchmark').innerText = profile.bench !== '--' ? `æ ‡æ†: ${profile.bench}` : '';
            if (currentStats) {
                currentStats.profile = profile;
                updateStatsUI(currentStats);
                generatePrompt(currentStats);
            }
        }

        // æ–‡ä»¶å¤„ç†
        const fileInput = document.getElementById('fileInput');
        fileInput.onchange = (e) => { if (e.target.files.length) processFile(e.target.files[0]); };

        // æ‹–æ‹½
        const layout = document.getElementById('main-layout');
        document.body.addEventListener('dragover', e => { e.preventDefault(); });
        document.body.addEventListener('drop', e => {
            e.preventDefault();
            if (e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]);
        });

        function processFile(file) {
            document.getElementById('loader').style.display = 'block';
            const reader = new FileReader();
            reader.onload = (e) => parseCSV(e.target.result);
            reader.readAsText(file);
        }

        function parseCSV(csv) {
            const lines = csv.split('\n');
            let headerIndex = -1;
            meta = { track: 'Unknown', car: 'Unknown' };

            for (let i = 0; i < 30; i++) {
                if (!lines[i]) continue;
                if (lines[i].includes('"Venue"')) meta.track = lines[i].split(',')[1].replace(/"/g, '');
                if (lines[i].includes('"Vehicle"')) meta.car = lines[i].split(',')[1].replace(/"/g, '');
                if (lines[i].includes('"Time"') && lines[i].includes('"Distance"')) { headerIndex = i; break; }
            }

            if (headerIndex === -1) {
                alert("CSV æ ¼å¼æ— æ³•è¯†åˆ« (Need Motec Standard Export)");
                document.getElementById('loader').style.display = 'none';
                return;
            }

            Papa.parse(lines.slice(headerIndex).join('\n'), {
                header: true, dynamicTyping: true, skipEmptyLines: true,
                complete: (res) => {
                    let clean = res.data;
                    if (typeof clean[0]['Time'] === 'string') clean.shift();
                    rawData = clean;
                    maxDistance = rawData[rawData.length - 1]['Distance'];
                    document.querySelectorAll('.help-tip').forEach(e => e.style.display = 'none');
                    document.getElementById('btn-reset').style.display = window.innerWidth > 768 ? 'block' : 'none';

                    // Auto Select Track
                    let match = 'default';
                    const lowerTrack = meta.track.toLowerCase();
                    for (let k in TRACK_DB) {
                        if (k !== 'default' && lowerTrack.includes(k)) match = k;
                    }
                    document.getElementById('track-selector').value = match;
                    updateTrackProfile(match);

                    // Render
                    renderCharts();
                    analyzeAndDisplay();
                    document.getElementById('loader').style.display = 'none';
                }
            });
        }

        function analyzeAndDisplay() {
            currentStats = analyzeDriving();
            const selector = document.getElementById('track-selector');
            currentStats.profile = TRACK_DB[selector.value || 'default'];
            updateStatsUI(currentStats);
            generatePrompt(currentStats);
        }

        function analyzeDriving() {
            const d = rawData;
            let s = { maxSpeed: 0, minSpeed: 999, coast: 0, trail: 0, noise: 0, brakeNoise: 0, time: d[d.length - 1]['Time'] };
            let corners = [];

            for (let i = 1; i < d.length; i++) {
                let r = d[i];
                let spd = r['Ground Speed'];
                let thr = r['Throttle Pos'];
                let brk = r['Brake Pos'];
                let str = Math.abs(r['Steering']);

                s.maxSpeed = Math.max(s.maxSpeed, spd);
                if (spd > 30 && spd < s.minSpeed) s.minSpeed = spd;
                if (thr < 5 && brk < 5 && spd > 50) s.coast++;
                if (brk > 5 && str > 5) s.trail++;
                if (thr > 10 && thr < 90) s.noise += Math.abs(thr - d[i - 1]['Throttle Pos']);
                if (brk > 10 && brk < 90) s.brakeNoise += Math.abs(brk - d[i - 1]['Brake Pos']);

                // Simple Corner Detection for prompt
                if (i > 20 && i < d.length - 20 && spd < 120 && spd < d[i - 10]['Ground Speed'] && spd < d[i + 10]['Ground Speed']) {
                    if (!corners.length || r['Distance'] - corners[corners.length - 1].dist > 150) {
                        corners.push({ dist: r['Distance'], speed: spd });
                    }
                }
            }

            s.coastPct = (s.coast / d.length * 100).toFixed(1);
            s.trailPct = (s.trail / d.length * 100).toFixed(1);
            s.smoothScore = Math.max(0, 100 - (s.noise / d.length * 200)).toFixed(0);
            s.brakeSmoothScore = Math.max(0, 100 - (s.brakeNoise / d.length * 200)).toFixed(0);
            s.slowCorners = corners.sort((a, b) => a.speed - b.speed).slice(0, 3);
            return s;
        }

        function updateStatsUI(s) {
            document.getElementById('val-time').innerText = s.time.toFixed(3);
            document.getElementById('val-top').innerText = s.maxSpeed.toFixed(0);

            const coastEl = document.getElementById('val-coast');
            coastEl.innerText = s.coastPct + '%';
            document.getElementById('target-coast').innerText = `Ref: ${s.profile.coast[0]}-${s.profile.coast[1]}%`;
            coastEl.style.color = s.coastPct > s.profile.coast[1] + 5 ? colors.red : (s.coastPct > s.profile.coast[1] ? colors.warn : colors.green);

            const trailEl = document.getElementById('val-trail');
            trailEl.innerText = s.trailPct + '%';
            document.getElementById('target-trail').innerText = `Ref: ${s.profile.trail[0]}-${s.profile.trail[1]}%`;
            trailEl.style.color = s.trailPct < s.profile.trail[0] ? colors.warn : colors.green;

            document.getElementById('val-smooth').innerText = s.smoothScore;
            document.getElementById('val-brake-smooth').innerText = s.brakeSmoothScore;
        }

        function generatePrompt(s) {
            promptText = `åˆ†æè½¦å‹${meta.car}åœ¨${s.profile.label}èµ›é“çš„æ•°æ®ï¼šåœˆé€Ÿ${s.time.toFixed(3)}ï¼Œæé€Ÿ${s.maxSpeed}ï¼Œæ»‘è¡Œ${s.coastPct}%(å‚è€ƒ${s.profile.coast.join('-')})ï¼Œå¾ªè¿¹åˆ¹è½¦${s.trailPct}%(å‚è€ƒ${s.profile.trail.join('-')})ã€‚è¯·ç»™å‡º3ä¸ªé’ˆå¯¹è¯¥è½¦å‹å’Œèµ›é“ç‰¹æ€§çš„æå‡å»ºè®®ã€‚`;
        }

        function renderCharts() {
            const dist = rawData.map(d => d['Distance']);
            const common = {
                responsive: true, maintainAspectRatio: false, animation: false,
                interaction: { mode: 'index', intersect: false },
                elements: { point: { radius: 0 } },
                scales: { x: { display: false, type: 'linear', max: maxDistance }, y: { grid: { color: colors.grid }, ticks: { color: colors.text } } },
                plugins: { legend: { labels: { color: colors.text } } }
            };

            // Main Chart
            if (charts.main) charts.main.destroy();
            charts.main = new Chart(document.getElementById('mainChart'), {
                type: 'line',
                data: {
                    labels: dist,
                    datasets: [
                        { label: 'Speed', data: rawData.map(d => d['Ground Speed']), borderColor: colors.cyan, borderWidth: 2, yAxisID: 'y' },
                        { label: 'RPM', data: rawData.map(d => d['Engine RPM']), borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1, fill: true, yAxisID: 'y1' },
                        { label: 'Gear', data: rawData.map(d => d['Gear']), borderColor: colors.gold, borderWidth: 2, stepped: true, yAxisID: 'y2' }
                    ]
                },
                options: {
                    ...common,
                    scales: { ...common.scales, y: { position: 'left' }, y1: { display: false, min: 0 }, y2: { position: 'right', min: 0, max: 8, grid: { display: false } } },
                    plugins: { ...common.plugins, zoom: { zoom: { wheel: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'x' } } }
                }
            });

            // Input Chart
            if (charts.input) charts.input.destroy();
            charts.input = new Chart(document.getElementById('inputChart'), {
                type: 'line',
                data: {
                    labels: dist,
                    datasets: [
                        { label: 'Throttle', data: rawData.map(d => d['Throttle Pos']), borderColor: colors.green, borderWidth: 1 },
                        { label: 'Brake', data: rawData.map(d => d['Brake Pos']), borderColor: colors.red, borderWidth: 1 },
                        { label: 'Steer', data: rawData.map(d => d['Steering']), borderColor: '#9b59b6', borderWidth: 1 }
                    ]
                },
                options: { ...common, scales: { ...common.scales, y: { min: 0, max: 105 } } }
            });

            // GG Chart & Map Chart (ç•¥å¾®ç®€åŒ–ä»£ç ï¼Œé€»è¾‘åŒå‰)
            if (charts.gg) charts.gg.destroy();
            charts.gg = new Chart(document.getElementById('ggChart'), {
                type: 'scatter',
                data: { datasets: [{ data: rawData.filter((_, i) => i % 5 === 0).map(d => ({ x: d['G Force Lat'], y: d['G Force Long'] })), backgroundColor: 'rgba(0,191,255,0.4)', pointRadius: 1 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { min: -3, max: 3, grid: { color: colors.grid } }, y: { min: -3, max: 3, grid: { color: colors.grid } } }, plugins: { legend: { display: false } } }
            });

            // Map Render
            if (charts.map) charts.map.destroy();
            const lats = rawData.map(d => d['GPS Latitude']);
            mapRatio = Math.cos(((Math.min(...lats) + Math.max(...lats)) / 2) * Math.PI / 180);
            const mapData = rawData.map(d => ({ x: d['GPS Longitude'] * mapRatio, y: d['GPS Latitude'] }));
            charts.map = new Chart(document.getElementById('mapChart'), {
                type: 'scatter',
                data: { datasets: [{ data: mapData, borderColor: 'white', borderWidth: 2, showLine: true, pointRadius: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { display: false } }, plugins: { legend: { display: false } } }
            });
        }

        // ==========================================
        // === PDF DOWNLOAD FUNCTION (NEW) ===
        // ==========================================
        async function generatePDF() {
            if (!rawData.length) {
                alert("è¯·å…ˆå¯¼å…¥æ•°æ®ï¼");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();

            // 1. Header Info
            doc.setFillColor(20, 20, 20); // Dark header
            doc.rect(0, 0, pageWidth, 30, 'F');
            doc.setTextColor(255, 215, 0); // Gold
            doc.setFontSize(22);
            doc.text("PITWALL AI REPORT", 10, 12);

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.text(`Track: ${meta.track}`, 10, 20);
            doc.text(`Vehicle: ${meta.car}`, 10, 25);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 150, 20);

            // 2. Stats Summary
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(14);
            doc.text("Session Statistics", 10, 40);

            const statsY = 50;
            doc.setFontSize(10);
            doc.text(`Lap Time: ${currentStats.time.toFixed(3)} s`, 10, statsY);
            doc.text(`Top Speed: ${currentStats.maxSpeed.toFixed(0)} km/h`, 70, statsY);
            doc.text(`Coasting: ${currentStats.coastPct}%`, 130, statsY);

            doc.text(`Trail Braking: ${currentStats.trailPct}%`, 10, statsY + 6);
            doc.text(`Throttle Smooth: ${currentStats.smoothScore}`, 70, statsY + 6);
            doc.text(`Brake Smooth: ${currentStats.brakeSmoothScore}`, 130, statsY + 6);

            // 3. Add Charts (Capture Base64)
            // Function to add chart image to PDF
            const addChartToPDF = (chartId, title, yPos, height) => {
                const canvas = document.getElementById(chartId);
                if (canvas) {
                    const imgData = canvas.toDataURL("image/png");
                    doc.setFillColor(240, 240, 240);
                    doc.rect(10, yPos - 5, pageWidth - 20, height + 10, 'F'); // Background box
                    doc.setFontSize(11);
                    doc.setTextColor(0, 0, 0);
                    doc.text(title, 10, yPos);
                    doc.addImage(imgData, 'PNG', 10, yPos + 2, pageWidth - 20, height);
                }
            };

            // Main Telemetry (å³ä½¿åœ¨æ‰‹æœºä¸Šè¢«éšè—ï¼ŒCanvas ä»æœ‰å†…å®¹)
            addChartToPDF('mainChart', 'Speed & RPM Telemetry', 70, 60);

            // Input Telemetry
            addChartToPDF('inputChart', 'Driver Inputs (Throttle/Brake)', 140, 60);

            // Map & GG (æ”¾åœ¨åŒä¸€è¡Œ)
            const mapCanvas = document.getElementById('mapChart');
            const ggCanvas = document.getElementById('ggChart');

            doc.text("Track Map & G-Force", 10, 215);
            if (mapCanvas) doc.addImage(mapCanvas.toDataURL("image/png"), 'PNG', 10, 220, 90, 60);
            if (ggCanvas) doc.addImage(ggCanvas.toDataURL("image/png"), 'PNG', 110, 220, 90, 60);

            // Footer
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text("Generated by PitWall AI Pro", 10, 290);

            doc.save(`Telemetery_${meta.track}_${new Date().getTime()}.pdf`);
        }

        // Chart Utils
        function resetZoom() { if (charts.main) charts.main.resetZoom(); if (charts.input) charts.input.resetZoom(); }
        function askAI(platform) {
            if (!promptText) { alert("è¯·å…ˆå¯¼å…¥æ•°æ®"); return; }
            navigator.clipboard.writeText(promptText).then(() => {
                const w = Math.max(450, window.screen.width * 0.3);
                const urls = { yuanbao: "https://yuanbao.tencent.com/chat", deepseek: "https://chat.deepseek.com/" };
                window.open(urls[platform], 'AI', `width=${w},height=${window.screen.height},left=${window.screen.width - w},top=0`);
            });
        }

        initTrackSelector();
    </script>
</body>

</html>
