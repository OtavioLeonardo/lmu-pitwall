<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMU 燃油圈数计算表 | Race Data</title>

    <!-- 引用外部 CSS -->
    <link rel="stylesheet" href="../css/race-theme.css">
    <link rel="stylesheet" href="../css/style.css">

    <style>
        /* 本地特定样式补充 */
        .calculator-section {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-main);
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .calc-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        @media (min-width: 768px) {
            .calc-grid {
                grid-template-columns: repeat(3, 1fr) auto;
                align-items: end;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .form-select,
        .form-input {
            background-color: var(--bg-card);
            border: 1px solid var(--border-light);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 2px;
            font-family: var(--font-stack);
            font-size: 14px;
        }

        .form-select:focus,
        .form-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .result-box {
            background-color: var(--bg-core);
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            padding: 15px;
            text-align: center;
            border-radius: 4px;
            min-width: 120px;
        }

        .result-value {
            font-size: 24px;
            font-weight: bold;
            display: block;
        }

        .result-label {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        /* 隐藏/显示表格按钮 (仅移动端优化体验) */
        .toggle-table-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            color: var(--accent-cyan);
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 12px;
            font-weight: bold;
        }

        .toggle-table-btn:hover {
            background: var(--bg-panel);
            border-color: var(--accent-cyan);
        }
    </style>
</head>

<body>

    <div class="container">

        <div class="guide-section">
            <h1 class="guide-title">LMU 燃油/Stint 计算器</h1>
            <p class="guide-desc">QUICK CALCULATOR & REFERENCE TABLE</p>

            <!-- ========================== -->
            <!-- 新增：交互式计算器板块 -->
            <!-- ========================== -->
            <div class="calculator-section">
                <div class="calc-grid">
                    <!-- 1. 选择组别 -->
                    <div class="form-group">
                        <label class="form-label">Car Class (组别)</label>
                        <select id="classSelect" class="form-select" onchange="updateTrackList()">
                            <option value="" disabled selected>Select Class...</option>
                            <!-- JS populate -->
                        </select>
                    </div>

                    <!-- 2. 选择赛道 -->
                    <div class="form-group">
                        <label class="form-label">Track (赛道)</label>
                        <select id="trackSelect" class="form-select" disabled onchange="calculateLaps()">
                            <option value="">Select Class First...</option>
                        </select>
                    </div>

                    <!-- 3. 输入时间 -->
                    <div class="form-group">
                        <label class="form-label">Race Time (Minutes)</label>
                        <input type="number" id="timeInput" class="form-input" value="60" min="1"
                            oninput="calculateLaps()">
                    </div>

                    <!-- 4. 结果显示 -->
                    <div class="result-box">
                        <span class="result-value" id="resultLaps">--</span>
                        <span class="result-label">Total Laps (+1)</span>
                    </div>
                </div>
                <div style="margin-top: 10px; font-size: 11px; color: var(--text-muted); text-align: right;">
                    *Based on Best Lap Time + Buffer
                </div>
            </div>

            <!-- 说明卡片 -->
            <div class="guide-grid">
                <div class="guide-card">
                    <h3>[01] LOGIC</h3>
                    <p style="font-size: 12px; margin: 0; color: var(--text-secondary);">
                        计算公式：<code>(Duration / BestLap) + 1</code>。<br>
                        基于极限圈速计算，确保油量足以覆盖“最坏情况”（多跑一圈）。
                    </p>
                </div>
                <!-- 移动端隐藏不重要的卡片以节省空间 -->
                <div class="guide-card hidden-mobile">
                    <h3>[02] LEGEND</h3>
                    <div class="legend-item">
                        <div class="legend-box col-short"></div> <strong>Sprint (&lt;20m)</strong>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box highlight-border"></div> <strong style="color:var(--accent-gold)">1
                            Hour</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- 表格折叠按钮 -->
        <button class="toggle-table-btn" onclick="toggleTable()">
            ▼ Show/Hide Full Reference Table
        </button>

        <!-- 完整表格区域 -->
        <div class="table-wrapper" id="mainTableWrapper">
            <table id="fuelTable">
                <thead>
                    <tr class="header-main">
                        <th class="track-name" style="z-index: 30;">TRACK / CIRCUIT</th>
                        <th class="laptime-col" style="z-index: 30;">BEST</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>

        <div class="footer">
            Telemetry System v2.2 // Calc & Data
        </div>
    </div>

    <script>
        // --- 完整数据 ---
        // (保持您原有的数据结构不变，这里只列出部分示例以节省空间，
        //  但在实际文件中请保留您上面提供的完整 allData 数组)
        const allData = [
            {
                class: "LMGT3",
                tracks: [
                    ["Bahrain (wec)", "1:59.38"], ["Bahrain (endurance)", "2:27.24"], ["Bahrain (outer)", "1:12.89"], ["Bahrain (paddock)", "1:21.59"],
                    ["Circuit de la Sarthe", "3:56.91"], ["Circuit de la Sarthe (straight)", "3:40.94"],
                    ["COTA", "2:06.33"], ["COTA (national)", "1:31.03"],
                    ["Fuji (chicane)", "1:40.55"], ["Fuji (classic)", "1:36.70"],
                    ["Imola", "1:42.41"], ["Interlagos", "1:34.15"],
                    ["Monza", "1:49.21"], ["Monza (curvagrande)", "1:40.00"],
                    ["Paul Ricard", "2:04.14"], ["Portimao", "1:43.67"],
                    ["Qatar", "1:54.70"], ["Qatar (short)", "1:09.81"],
                    ["Silverstone", "1:58.65"], ["Sebring", "2:00.79"], ["Sebring (school)", "1:03.52"], ["Spa", "2:17.93"]
                ]
            },
            {
                class: "LMH",
                tracks: [
                    ["Bahrain (wec)", "1:44.51"], ["Bahrain (endurance)", "2:09.29"], ["Bahrain (outer)", "1:03.68"], ["Bahrain (paddock)", "1:11.20"],
                    ["Circuit de la Sarthe", "3:22.47"], ["Circuit de la Sarthe (straight)", "3:08.98"],
                    ["COTA", "1:51.61"], ["COTA (national)", "1:20.55"],
                    ["Fuji (chicane)", "1:28.11"], ["Fuji (classic)", "1:24.17"],
                    ["Imola", "1:29.34"], ["Interlagos", "1:23.03"],
                    ["Monza", "1:34.31"], ["Monza (curvagrande)", "1:25.64"],
                    ["Paul Ricard", "1:47.94"], ["Portimao", "1:31.04"],
                    ["Qatar", "1:38.66"], ["Qatar (short)", "0:58.86"],
                    ["Silverstone", "1:41.79"], ["Sebring", "1:45.03"], ["Sebring (school)", "0:54.76"], ["Spa", "1:59.52"]
                ]
            },
            {
                class: "LMP3",
                tracks: [
                    ["Bahrain (wec)", "1:54.64"], ["Bahrain (endurance)", "2:20.65"], ["Bahrain (outer)", "1:10.15"], ["Bahrain (paddock)", "1:17.87"],
                    ["Circuit de la Sarthe", "3:45.94"], ["Circuit de la Sarthe (straight)", "3:30.90"],
                    ["COTA", "2:00.97"], ["COTA (national)", "1:27.02"],
                    ["Fuji (chicane)", "1:35.87"], ["Fuji (classic)", "1:32.55"],
                    ["Imola", "1:38.53"], ["Interlagos", "1:29.67"],
                    ["Monza", "1:44.40"], ["Monza (curvagrande)", "1:35.51"],
                    ["Paul Ricard", "1:57.72"], ["Portimao", "1:39.03"],
                    ["Qatar", "1:47.53"], ["Qatar (short)", "1:05.49"],
                    ["Silverstone", "1:51.85"], ["Sebring", "1:55.07"], ["Sebring (school)", "1:00.55"], ["Spa", "2:11.49"]
                ]
            },
            {
                class: "LMP2 ELMS",
                tracks: [
                    ["Bahrain (wec)", "1:47.18"], ["Bahrain (endurance)", "2:12.20"], ["Bahrain (outer)", "1:05.32"], ["Bahrain (paddock)", "1:13.04"],
                    ["Circuit de la Sarthe", "3:27.86"], ["Circuit de la Sarthe (straight)", "3:14.34"],
                    ["COTA", "1:53.37"], ["COTA (national)", "1:21.49"],
                    ["Fuji (chicane)", "1:29.35"], ["Fuji (classic)", "1:25.67"],
                    ["Imola", "1:30.93"], ["Interlagos", "1:23.27"],
                    ["Monza", "1:36.29"], ["Monza (curvagrande)", "1:27.78"],
                    ["Paul Ricard", "1:49.79"], ["Portimao", "1:32.36"],
                    ["Qatar", "1:38.89"], ["Qatar (short)", "0:59.26"],
                    ["Silverstone", "1:42.58"], ["Sebring", "1:47.13"], ["Sebring (school)", "0:55.40"], ["Spa", "2:02.08"]
                ]
            },
            {
                class: "LMP2 WEC",
                tracks: [
                    ["Bahrain (wec)", "1:49.61"], ["Bahrain (endurance)", "2:15.81"], ["Bahrain (outer)", "1:06.48"], ["Bahrain (paddock)", "1:14.69"],
                    ["Circuit de la Sarthe", "3:33.36"], ["Circuit de la Sarthe (straight)", "3:19.54"],
                    ["COTA", "1:56.93"], ["COTA (national)", "1:24.21"],
                    ["Fuji (chicane)", "1:31.99"], ["Fuji (classic)", "1:28.18"],
                    ["Imola", "1:34.42"], ["Interlagos", "1:25.99"],
                    ["Monza", "1:39.66"], ["Monza (curvagrande)", "1:30.07"],
                    ["Paul Ricard", "1:53.22"], ["Portimao", "1:35.51"],
                    ["Qatar", "1:43.27"], ["Qatar (short)", "1:01.90"],
                    ["Silverstone", "1:47.05"], ["Sebring", "1:49.94"], ["Sebring (school)", "0:56.99"], ["Spa", "2:05.57"]
                ]
            },
            {
                class: "GTE",
                tracks: [
                    ["Bahrain (wec)", "1:57.06"], ["Bahrain (endurance)", "2:23.84"], ["Bahrain (outer)", "1:11.54"], ["Bahrain (paddock)", "1:19.81"],
                    ["Circuit de la Sarthe", "3:51.65"], ["Circuit de la Sarthe (straight)", "3:35.22"],
                    ["COTA", "2:03.18"], ["COTA (national)", "1:27.67"],
                    ["Fuji (chicane)", "1:37.40"], ["Fuji (classic)", "1:33.24"],
                    ["Imola", "1:40.73"], ["Interlagos", "1:32.94"],
                    ["Monza", "1:46.78"], ["Monza (curvagrande)", "1:37.49"],
                    ["Paul Ricard", "2:03.70"], ["Portimao", "1:42.11"],
                    ["Qatar", "1:52.40"], ["Qatar (short)", "1:07.81"],
                    ["Silverstone", ""],
                    ["Sebring", "1:58.79"], ["Sebring (school)", "1:01.70"], ["Spa", "2:15.67"]
                ]
            }
        ];

        // --- 时间点配置 (用于下方表格) ---
        const timeConfig = [
            4, 6, 8, 10, 15,    // Short
            20, 25, 30, 35,     // Medium
            40, 45, 50, 55,     // Long
            60,                 // Highlight (1h)
            65, 70, 75, 80, 85, 90 // Endurance
        ];

        // --- 辅助函数 ---
        function formatTimeHeader(min) {
            const h = Math.floor(min / 60);
            const m = min % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function parseToSeconds(str) {
            if (!str) return null;
            const p = str.split(':');
            return (parseInt(p[0]) * 60) + parseFloat(p[1]);
        }

        // ==========================================
        // === Calculator Logic (Mobile Friendly) ===
        // ==========================================

        const classSelect = document.getElementById('classSelect');
        const trackSelect = document.getElementById('trackSelect');
        const timeInput = document.getElementById('timeInput');
        const resultLaps = document.getElementById('resultLaps');

        // 1. 初始化组别下拉菜单
        function initCalculator() {
            allData.forEach((item, index) => {
                const opt = document.createElement('option');
                opt.value = index; // 用数组索引作为值
                opt.textContent = item.class;
                classSelect.appendChild(opt);
            });
        }

        // 2. 组别改变时，更新赛道列表
        function updateTrackList() {
            const classIndex = classSelect.value;
            const trackData = allData[classIndex].tracks;

            // 清空并启用赛道选择
            trackSelect.innerHTML = '<option value="" disabled selected>Select Track...</option>';
            trackSelect.disabled = false;

            trackData.forEach((track, index) => {
                const opt = document.createElement('option');
                opt.value = track[1]; // 将圈速时间字符串直接作为 value
                opt.textContent = track[0];
                trackSelect.appendChild(opt);
            });

            // 重置结果
            resultLaps.textContent = "--";
        }

        // 3. 计算逻辑
        function calculateLaps() {
            const lapTimeStr = trackSelect.value;
            const durationMin = parseFloat(timeInput.value);

            if (!lapTimeStr || !durationMin || durationMin <= 0) {
                resultLaps.textContent = "--";
                return;
            }

            const lapSeconds = parseToSeconds(lapTimeStr);
            if (!lapSeconds) {
                resultLaps.textContent = "Err";
                return;
            }

            // 核心公式：(总秒数 / 单圈秒数) 向上取整 + 1圈(Buffer)
            // 原表格逻辑是Math.ceil，这里为了保险起见，严格按照策略逻辑
            // 通常做法：总时间/圈速 = 跑的圈数。如果正好除尽，往往需要多跑一圈以防万一。
            // 这里沿用表格的逻辑：Math.ceil((min * 60) / sec)
            const totalSeconds = durationMin * 60;
            const laps = Math.ceil(totalSeconds / lapSeconds);

            // 显示结果
            resultLaps.textContent = laps;
        }

        // ==========================================
        // === Table Logic (Reference)            ===
        // ==========================================

        function generateTable() {
            const theadRow = document.querySelector('.header-main');
            const tbody = document.getElementById('tableBody');

            // 1. 生成表头
            timeConfig.forEach(min => {
                const th = document.createElement('th');
                th.textContent = formatTimeHeader(min);
                if (min === 60) th.className = 'highlight-border';
                else if (min < 20) th.className = 'col-short';
                else if (min < 40) th.className = 'col-med';
                else if (min < 60) th.className = 'col-long';
                else th.className = 'col-endur';
                theadRow.appendChild(th);
            });

            // 2. 生成数据行
            allData.forEach(cat => {
                const secRow = document.createElement('tr');
                secRow.className = 'section-header';
                const secTd = document.createElement('td');
                secTd.colSpan = timeConfig.length + 2;
                secTd.textContent = cat.class;
                secRow.appendChild(secTd);
                tbody.appendChild(secRow);

                cat.tracks.forEach(track => {
                    const tr = document.createElement('tr');
                    const [name, timeStr] = track;
                    const sec = parseToSeconds(timeStr);

                    const tdName = document.createElement('td');
                    tdName.className = 'track-name';
                    tdName.textContent = name;
                    tr.appendChild(tdName);

                    const tdTime = document.createElement('td');
                    tdTime.className = 'laptime-col';
                    tdTime.textContent = timeStr || "-";
                    tr.appendChild(tdTime);

                    timeConfig.forEach(min => {
                        const td = document.createElement('td');
                        if (min === 60) td.className = 'highlight-border';
                        else if (min < 20) td.className = 'col-short';
                        else if (min < 40) td.className = 'col-med';
                        else if (min < 60) td.className = 'col-long';
                        else td.className = 'col-endur';

                        if (sec) {
                            const laps = Math.ceil((min * 60) / sec);
                            td.textContent = laps;
                        } else {
                            td.textContent = "-";
                            td.classList.add('empty-data');
                        }
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
            });
        }

        function toggleTable() {
            const wrapper = document.getElementById('mainTableWrapper');
            if (wrapper.style.display === 'none') {
                wrapper.style.display = 'block';
            } else {
                wrapper.style.display = 'none';
            }
        }

        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            initCalculator();
            generateTable();

            // 移动端默认折叠表格，PC端展开
            if (window.innerWidth < 768) {
                document.getElementById('mainTableWrapper').style.display = 'none';
            }
        });

    </script>

</body>

</html>
